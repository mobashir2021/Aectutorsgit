@using AECMIS.MVC.Binders
@model AECMIS.DAL.Domain.DTO.SessionRegisterViewModel
@using Newtonsoft.Json
@{
    ViewBag.Title = "SessionRegister";
}
@using (Html.BeginForm("SaveRegister", "SessionRegister", FormMethod.Post, new { @id = "___mainForm" }))
{
    @Html.ValidationSummary(false)

    <h2>SessionRegister</h2>

     <div class="container">
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label for="center">Code</label>
                    <select class="form-control" id="center" name="center" data-bind="disable:RegisterLocationDetailsAreReadOnly, options:Centers,optionsCaption:'--select--', optionsText:'Name',optionsValue:'Id',value:Center">
                    </select>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="session">Session</label>
                    <select class="form-control" id="session" name="session" data-bind="disable:RegisterLocationDetailsAreReadOnly,options:SessionsByCenter,optionsCaption:'--select--', optionsText:'SessionDetails',optionsValue:'SessionId',value:SessionId">
                    </select>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="date">Date</label>
                    <input class="form-control date" type="text" id="date" name="date" readonly="readonly" autocomplete="off" data-bind="disable:RegisterLocationDetailsAreReadOnly,datepicker:Date, datepickerOptions: { dateFormat: 'dd/mm/yy', changeMonth: true, changeYear: true, yearRange: '2000:2025',beforeShowDay:disableSpecificWeekDays } " />
                </div>
            </div>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-condensed" data-bind="visible: ShowRegister()">
            <thead>
                <tr>
                    <td>Student No.</td>
                    <td>Name</td>
                    <td>Subject</td>
                    <td>Teacher</td>
                    <td>Status</td>
                    <td>PaymentType</td>
                    <td>Payment</td>
                    <td>Payment Date</td>
                    <td>Cheque No.</td>
                    <td></td>
                    <td></td>
                </tr>
            </thead>
            <tbody data-bind="foreach: SessionAttendees">
                <tr>
                    <td data-bind="text: $data.StudentNo"></td>
                    <td data-bind="text: $data.Name"></td>
                    <td>
                        <select id="subject" name="subject" data-bind="disable:$root.RegisterDetailsAreReadOnly,options:$data.Subjects,optionsCaption:'--select--', optionsText:'Name',optionsValue:'SubjectId', value:$data.SessionAttendanceViewModel().SubjectId">
                        </select>
                    </td>
                    <td>
                        <select id="teacher" name="teacher" data-bind="disable:$root.RegisterDetailsAreReadOnly,options:$root.AllTeachers,optionsCaption:'--select--', optionsText:'FirstName',optionsValue:'Id', value:$data.SessionAttendanceViewModel().TeacherId">
                        </select>
                    </td>
                    <td>
                        <select id="status" name="status" data-bind="disable:$root.RegisterDetailsAreReadOnly, options:$root.AttendanceStatuses,optionsCaption:'--select--', optionsText:'Text',optionsValue:'Value', value:$data.SessionAttendanceViewModel().Status">
                        </select>
                    </td>
                    <td>
                        <div data-bind="if:$data.SessionAttendanceViewModel().PaymentRequired">
                            <select id="paymentType" name="paymentType" data-bind="options:$root.paymentTypes,optionsCaption:'--select--', optionsText:'Text',optionsValue:'Value', value:$data.SessionAttendanceViewModel().FutureInvoicePayment.PaymentType">
                            </select>
                        </div>
                    </td>
                    <td>
                        <div data-bind="if:$data.SessionAttendanceViewModel().PaymentRequired">
                            <select id="payment" name="payment" data-bind="options:$data.SessionAttendanceViewModel().FutureInvoicePayment.PaymentPlans,optionsCaption:'--select--', optionsText:'PaymentAmountInCurrency',optionsValue:'Id', value:$data.SessionAttendanceViewModel().FutureInvoicePayment.PaymentAmount">
                            </select>
                        </div>
                        <div data-bind="ifnot:$data.SessionAttendanceViewModel().PaymentRequired">
                            <input value="PAID" type="text" readonly="readonly"  />
                        </div>
                    </td>
                    <td>
                         <div data-bind="if:$data.SessionAttendanceViewModel().PaymentRequired">
                             <input class="date paymentDateInput" name="paymentDate" readonly="readonly" autocomplete="off" type="text" data-bind="datepicker:$data.SessionAttendanceViewModel().FutureInvoicePayment.PaymentDate, datepickerOptions:{ dateFormat: 'dd/mm/yy', changeMonth: true, changeYear: true, yearRange:'2000:2025'}, uniqueName: true" />
                        </div>
                    </td>
                    <td>
                        <div data-bind="if:$data.SessionAttendanceViewModel().PaymentRequired && $data.SessionAttendanceViewModel().FutureInvoicePayment.PaymentType() == 3002 ">
                            <input class="chequeInput" type="text" id="chequeNo" name="chequeNo" data-bind="value:$data.SessionAttendanceViewModel().FutureInvoicePayment.ChequeNo" maxlength="6" />
                        </div>
                    </td>
                    <td class="buttons">
                        <button class="red btn btn-default btn-sm" data-bind="visible:$data.SessionAttendanceViewModel().OutstandingPayments().length > 0, click:function(){ $root.ViewOutstandingPayments($data.SessionAttendanceViewModel());}">
                            <span class="glyphicon glyphicon-warning-sign"></span>
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-default btn-sm"
                            data-bind="click:function(){ $root.ViewNotes($data.SessionAttendanceViewModel());}"
                            title="Notes">
                            <span class="glyphicon glyphicon-pencil"></span>
                        </button>
                        <button class="btn btn-default btn-sm" data-bind="disable:$root.RegisterDetailsAreReadOnly, click: function() { $root.DeleteSessionAttendee($data); }">
                            <span class="glyphicon glyphicon-trash"></span>
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <div>
        <button class="btn btn-default" type="button" data-bind="click:OpenSearchDialog, disable: $root.RegisterDetailsAreReadOnly"><span class="glyphicon glyphicon-plus"></span> Add Additional Students</button>
        <button class="btn btn-default" type="button" data-bind="click:Save,disable:SessionAttendees().length < 1 || $root.RegisterDetailsAreReadOnly"><span class="glyphicon glyphicon-floppy-disk"></span> Save</button>
        <button class="btn btn-default" type="button" data-bind="click:ProcessRegister, disable:SessionAttendees().length < 1 || $root.RegisterDetailsAreReadOnly"><span class="glyphicon glyphicon-play"></span> Process</button>
        
        <button class="btn btn-default" type="button" data-bind="click:UpdatePaymentDates, disable:SessionAttendees().length < 1 || $root.RegisterDetailsAreReadOnly"><span class="glyphicon glyphicon-refresh"></span> Update Payment Dates</button>
    </div>
    
    <!-- Modal -->
    @Html.Partial("_studentSearch")
    
    <!-- Modal -->
    @Html.Partial("_invoicePayments")
    
    <!-- Modal -->
    @Html.Partial("_notes")   
    
    <!--Modal -->
    @Html.Partial("_sessionRegisterSaveResult") 
    
    <!--Modal -->
    @Html.Partial("_captureAdminPassword")
      

}
<script src="@Url.Content("~/js/UIDialog.js")" type="text/javascript"></script>
<script src="@Url.Content("~/js/pagerViewModel.js")" type="text/javascript"></script>
<script src="@Url.Content("~/js/studentSearchViewModel.js")" type="text/javascript"></script>
<script src="@Url.Content("~/js/studentRegisterViewModel.js")" type="text/javascript"></script>
<script src="@Url.Content("~/js/ajaxoverlay.js")" type="text/javascript"></script>
<script src="@Url.Content("~/js/adminPassword.js")" type="text/javascript"></script>

<script src="~/js/KODatePicker.js" type="text/javascript" ></script>
<script type="text/javascript">
    $(function () {        

        var viewModel = new SessionRegisterViewModel(@Html.Raw(@Model.SerializeObject()),@Html.Raw(JsonConvert.SerializeObject(ViewData["Sessions"])));
        viewModel.Centers = @Html.Raw(ViewData["Centers"].SerializeObject());
        
        viewModel.AllTeachers = @Html.Raw(ViewData["Teachers"].SerializeObject());
        viewModel.AttendanceStatuses = @Html.Raw(JsonConvert.SerializeObject(ViewData["AttendanceStatuses"]));
        viewModel.curriculumTypes = ko.mapping.fromJS(@Html.Raw(JsonConvert.SerializeObject(ViewData["CurriculumTypes"])));
        viewModel.paymentTypes = @Html.Raw(ViewData["PaymentTypes"].SerializeObject());


        ko.validation.init({
            insertMessages: false,
            decorateInputElement: true,
            errorElementClass: "input-validation-error",
            errorClass:"input-validation-error",
            messagesOnModified: false,
            decorateElementOnModified:false,
            registerExtenders: true,
            grouping : { deep: false, observable: false}
        });

                        
//        ko.applyBindingsWithValidation(viewModel,$("#___mainForm")[0], {
//            insertMessages: false,
//            decorateElement: true,
//            errorElementClass: "input-validation-error",
//            errorClass:"input-validation-error",
//            messagesOnModified: false
//        });   

        ko.applyBindings(viewModel, $("#___mainForm")[0]);
    });
</script>
